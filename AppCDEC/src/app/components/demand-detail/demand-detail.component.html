<app-navbar></app-navbar>

<div class="demand-detail-container" *ngIf="!loading && demand">
  <div class="detail-header">
    <button class="back-button" (click)="goBack()">
      ← Voltar
    </button>
  </div>

  <div class="detail-content">
    <div class="info-section">
      <div class="demand-info-card">
        <div class="card-header">
          <h2>{{ demand.title }}</h2>
          <div class="status-badges">
            <span class="status-badge" [class]="demand.status">
              {{ getStatusText(demand.status) }}
            </span>
            <span class="priority-badge" [class]="demand.priority">
              {{ getPriorityText(demand.priority) }}
            </span>
          </div>
        </div>

        <div class="card-body">
          <div class="info-item">
            <strong>Descrição:</strong>
            <p>{{ demand.description }}</p>
          </div>

          <div class="info-item">
            <strong>Cidadão:</strong>
            <p>{{ demand.citizen?.name }}</p>
            <p class="small">{{ demand.citizen?.email }}</p>
          </div>

          <div class="info-item">
            <strong>Categoria:</strong>
            <p>{{ demand.category }}</p>
          </div>

          <div class="info-item">
            <strong>Data de Criação:</strong>
            <p>{{ formatDate(demand.created_at) }}</p>
          </div>

          <div class="info-item" *ngIf="demand.assigned_user">
            <strong>Atribuído a:</strong>
            <p>{{ demand.assigned_user.name }}</p>
          </div>
        </div>

        <div class="card-actions">
          <button
            *ngIf="demand.status === 'pending'"
            class="btn-assign"
            (click)="assignToMe()"
          >
            Atribuir para mim
          </button>

          <button
            *ngIf="demand.status === 'in_progress'"
            class="btn-complete"
            (click)="updateStatus('completed')"
          >
            Concluir Demanda
          </button>

          <button
            *ngIf="demand.status !== 'cancelled' && demand.status !== 'completed'"
            class="btn-cancel"
            (click)="updateStatus('cancelled')"
          >
            Cancelar Demanda
          </button>
        </div>
      </div>
    </div>

    <div class="chat-section">
      <div class="chat-card">
        <div class="chat-header">
          <h3>Mensagens</h3>
        </div>

        <div class="chat-messages">
          <div
            *ngFor="let message of messages"
            class="message"
            [class.my-message]="isMyMessage(message)"
          >
            <div class="message-avatar">
              @if (message.user && message.user.name) {
                {{ message.user.name.charAt(0).toUpperCase() }}
              } @else {
                U
              }
            </div>
            <div class="message-content">
              <div class="message-header">
                <strong>{{ message.user?.name || 'Usuário' }}</strong>
                <span class="message-time">{{ formatTime(message.created_at) }}</span>
              </div>
              <p>{{ message.message }}</p>
            </div>
          </div>

          <div class="empty-messages" *ngIf="messages.length === 0">
            Nenhuma mensagem ainda. Inicie a conversa!
          </div>
        </div>

        <div class="chat-input">
        <input
          type="text"
          [(ngModel)]="newMessage"
          placeholder="Digite sua mensagem..."
          [disabled]="sendingMessage"
        />
        <!-- (keyup.enter)="sendMessage()" desabilitado temporariamente -->

          <button
            (click)="sendMessage()"
            [disabled]="!newMessage.trim() || sendingMessage"
            class="send-button"
          >
            {{ sendingMessage ? 'Enviando...' : 'Enviar' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="loading-container" *ngIf="loading">
  Carregando detalhes...
</div>
